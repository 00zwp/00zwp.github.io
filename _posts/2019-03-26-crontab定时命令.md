---
layout:     post
title:      crontab定时命令
subtitle:    ""
date:       2019-03-26
author:     tianhaoo
header-img: img/post-bg/28.jpg
catalog: true
tags:
  - linux
---

最近在写综合实践项目的课程作业，都是一些简单的web端的小程序，说难吧不难，说简单吧，想要做的无可挑剔还真得花点时间。所以我选择糊弄过去。
我需要将那些程序部署在公网服务器上，但由于鲁棒性太差，多个用户同时登陆多操作几次就会有问题出现，重启一下才能好。
于是我需要一个linux下自动运行每天24点自动重启服务的shell脚本程序。然后我发现了crontab。


### 简介

Linux crontab是用来定期执行程序的命令。
当安装完成操作系统之后，默认便会启动此任务调度命令。
crontab命令每分锺会定期检查是否有要执行的工作，如果有要执行的工作便会自动执行该工作。
而linux任务调度的工作主要分为以下两类：

1. 系统执行的工作：系统周期性所要执行的工作，如备份系统数据、清理缓存
2. 个人执行的工作：某个用户定期要做的工作，例如每隔10分钟检查邮件服务器是否有新信号，这些工作可由每个用户自行设置

因此，通过crontab 命令，我们可以在固定的间隔时间执行指定的系统指令或 shell script脚本。时间间隔的单位可以是分钟、小时、日、月、周及以上的任意组合。这个命令非常适合周期性的日志分析或数据备份等工作。

### 使用

该命令的使用很简单，只有三个选项

* `-e` 进入文本编辑器，编辑具体的定时任务

* `-l` 列出所有的定时任务

* `-r` 删除所有的定时任务

但是在设定时间和任务时，语法有点反人类

`分 时 日 月 星期 要运行的命令`

* 第1列分钟0～59
* 第2列小时0～23（0表示子夜）
* 第3列日1～31
* 第4列月1～12
* 第5列星期0～7（0和7表示星期天）
* 第6列要运行的命令

例如想在每天24点重启一下某个py脚本可以这样写：
```
# 获取占用8888端口的Pid
netstat -anp|grep 8888|awk '{printf $7}'|cut -d/ -f1

# 通过管道将要kill的Pid传给kill是不行的，例如 echo 34543 | kill 是错误的。需要这样做: kill $(command) 或 kill `command`
# 杀掉8888端口的nohup进程要这样
kill -9 $(netstat -anp|grep 8888|awk '{printf $7}'|cut -d/ -f1)

# 启动的话要用绝对路径，python的路径可以用 which python3 得到
nohup /usr/bin/python3 /root/web_lottery/main.py &

# 合起来就是每天0点的时候杀掉占用8888端口的程序，然后再启动python脚本
00 00 * * * kill -9 $(netstat -anp|grep 8888|awk '{printf $7}'|cut -d/ -f1) && nohup /usr/bin/python3 /root/web_lottery/main.py &

```

完成~
